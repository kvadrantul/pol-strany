<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .info {
      color: #666;
      margin-bottom: 30px;
    }
    button {
      background: #09B3AF;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #079B97;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #results {
      margin-top: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 6px;
      display: none;
    }
    #results.show {
      display: block;
    }
    .stat {
      margin: 10px 0;
      padding: 10px;
      background: white;
      border-radius: 4px;
    }
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .info-text { color: #17a2b8; }
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 14px;
    }
    .result-item {
      padding: 5px 0;
      border-bottom: 1px solid #eee;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h1>
    <p class="info">
      –≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø–æ–ª–Ω–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö 20 –±—Ä–∏–≥–∞–¥–∞–º–∏ —Ä–∞–∑–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤.
      –ú–∏–≥—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ - —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã.
    </p>
    
    <button id="migrateBtn" onclick="runMigration()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é</button>
    <button onclick="checkContractors()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±—Ä–∏–≥–∞–¥—ã</button>
    
    <div id="results"></div>
  </div>

  <script>
    const API_URL = window.location.origin;

    async function runMigration() {
      const btn = document.getElementById('migrateBtn');
      const results = document.getElementById('results');
      
      btn.disabled = true;
      btn.textContent = '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
      results.innerHTML = '<p class="info-text">–ó–∞–ø—É—Å–∫–∞—é –º–∏–≥—Ä–∞—Ü–∏—é...</p>';
      results.classList.add('show');

      try {
        const response = await fetch(`${API_URL}/api/migrate`, {
          method: 'POST'
        });

        const data = await response.json();
        
        let html = '<h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–∏</h2>';
        
        html += `<div class="stat ${data.success ? 'success' : 'error'}">
          <strong>–°—Ç–∞—Ç—É—Å:</strong> ${data.success ? '‚úÖ –£—Å–ø–µ—à–Ω–æ' : '‚ùå –û—à–∏–±–∫–∏'}
        </div>`;
        
        html += `<div class="stat info-text">
          <strong>–î–æ–±–∞–≤–ª–µ–Ω–æ:</strong> ${data.added}<br>
          <strong>–û–±–Ω–æ–≤–ª–µ–Ω–æ:</strong> ${data.updated}<br>
          <strong>–û—à–∏–±–æ–∫:</strong> ${data.errors}<br>
          <strong>–í—Å–µ–≥–æ:</strong> ${data.total}
        </div>`;

        if (data.results && data.results.length > 0) {
          html += '<h3>–î–µ—Ç–∞–ª–∏:</h3><div style="max-height: 400px; overflow-y: auto;">';
          data.results.forEach(result => {
            html += `<div class="result-item">${result}</div>`;
          });
          html += '</div>';
        }

        html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        
        results.innerHTML = html;
      } catch (error) {
        results.innerHTML = `<div class="stat error">
          <strong>–û—à–∏–±–∫–∞:</strong> ${error.message}
        </div>`;
      } finally {
        btn.disabled = false;
        btn.textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é';
      }
    }

    async function checkContractors() {
      const results = document.getElementById('results');
      results.innerHTML = '<p class="info-text">–ü—Ä–æ–≤–µ—Ä—è—é –±—Ä–∏–≥–∞–¥—ã...</p>';
      results.classList.add('show');

      try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        const categories = ['econom', 'comfort', 'business', 'premium', 'universal', 'self-leveling'];
        const counts = {};

        for (const category of categories) {
          const response = await fetch(`${API_URL}/api/contractors/search?category=${category}`);
          if (response.ok) {
            const data = await response.json();
            counts[category] = data.contractors ? data.contractors.length : 0;
          }
        }

        let html = '<h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –±—Ä–∏–≥–∞–¥ –≤ –±–∞–∑–µ</h2>';
        html += '<div class="stat">';
        Object.entries(counts).forEach(([cat, count]) => {
          html += `<strong>${cat}:</strong> ${count} –±—Ä–∏–≥–∞–¥<br>`;
        });
        html += '</div>';

        results.innerHTML = html;
      } catch (error) {
        results.innerHTML = `<div class="stat error">
          <strong>–û—à–∏–±–∫–∞:</strong> ${error.message}
        </div>`;
      }
    }
  </script>
</body>
</html>

